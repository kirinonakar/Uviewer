<?xml version="1.0" encoding="utf-8"?>
<Window
    x:Class="Uviewer.MainWindow"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:local="using:Uviewer"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:canvas="using:Microsoft.Graphics.Canvas.UI.Xaml"
    xmlns:controls="using:CommunityToolkit.WinUI.Controls"
    mc:Ignorable="d"
    Title="Uviewer - Image &amp; Text Viewer">

    <Window.SystemBackdrop>
        <MicaBackdrop />
    </Window.SystemBackdrop>

    <Grid x:Name="RootGrid" AllowDrop="True"
          DragOver="Grid_DragOver" Drop="Grid_Drop"
          PointerMoved="RootGrid_PointerMoved"
          PointerExited="RootGrid_PointerExited">
        <Grid.Resources>
            <DataTemplate x:Key="TextItemTemplate">
                <TextBlock TextWrapping="Wrap" HorizontalAlignment="Left" />
            </DataTemplate>
            <DataTemplate x:Key="AozoraItemTemplate">
                <RichTextBlock IsTextSelectionEnabled="False" TextWrapping="Wrap" HorizontalAlignment="Left" Margin="0,0,0,10" />
            </DataTemplate>
        </Grid.Resources>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <!-- Custom Title Bar -->
        <Grid x:Name="AppTitleBar" Grid.Row="0" Height="32" Background="{ThemeResource CardBackgroundFillColorDefaultBrush}">
            <StackPanel Orientation="Horizontal" Spacing="8" VerticalAlignment="Center" Margin="12,0,0,0">
                <FontIcon Glyph="&#xE8B9;" FontSize="16"/>
                <TextBlock Text="Uviewer" FontWeight="SemiBold" FontSize="12" VerticalAlignment="Center"/>
            </StackPanel>
        </Grid>

        <!-- Title Bar & Toolbar -->
        <Grid x:Name="ToolbarGrid" Grid.Row="1" Padding="12,8" 
              Background="{ThemeResource CardBackgroundFillColorDefaultBrush}"
              BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}" BorderThickness="0,0,0,1">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="Auto"/>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="Auto"/>
            </Grid.ColumnDefinitions>

            <StackPanel Grid.Column="0" Orientation="Horizontal" Spacing="0" VerticalAlignment="Center">
                <Button x:Name="SettingsButton" Background="Transparent" BorderThickness="0" Padding="4" Margin="0,0,0,0" ToolTipService.ToolTip="설정">
                    <FontIcon Glyph="&#xE713;" FontSize="18"/>
                    <Button.Flyout>
                        <MenuFlyout Placement="Bottom">
                            <MenuFlyoutItem x:Name="ChangeFontMenuItem" Text="폰트 변경" Click="FontMenu_Click">
                                <MenuFlyoutItem.Icon>
                                    <FontIcon Glyph="&#xE8D2;"/>
                                </MenuFlyoutItem.Icon>
                            </MenuFlyoutItem>
                        </MenuFlyout>
                    </Button.Flyout>
                </Button>
                <ToggleButton x:Name="GlobalThemeToggleButton" Click="GlobalThemeToggleButton_Click" Background="Transparent" BorderThickness="0" Padding="4" Margin="4,0,0,0">
                    <FontIcon x:Name="ThemeIcon" Glyph="&#xE708;" FontSize="18"/>
                </ToggleButton>
            </StackPanel>

            <!-- Toolbar -->
            <StackPanel Grid.Column="2" Orientation="Horizontal" Spacing="4">
                <Button x:Name="ToggleSidebarButton" Click="ToggleSidebarButton_Click" ToolTipService.ToolTip="사이드바 토글(Ctrl+B)">
                    <FontIcon Glyph="&#xE8A0;" FontSize="14"/>
                </Button>

                <Button x:Name="FavoritesButton" Click="FavoritesButton_Click" ToolTipService.ToolTip="즐겨찾기">
                    <FontIcon Glyph="&#xE734;" FontSize="14"/>
                    <Button.Flyout>
                        <Flyout x:Name="FavoritesFlyout" Placement="Bottom">
                            <ScrollViewer MaxHeight="400" Width="400" 
                                         HorizontalScrollBarVisibility="Disabled" 
                                         VerticalScrollBarVisibility="Auto">
                                <StackPanel x:Name="FavoritesPanel" Spacing="2">
                                    <Button x:Name="AddToFavoritesButton" Content="➕ 즐겨찾기 추가" Click="AddToFavoritesMenuItem_Click" 
                                            HorizontalAlignment="Stretch" HorizontalContentAlignment="Left"
                                            Background="Transparent" BorderThickness="0"/>
                                    <Border Height="1" Background="{ThemeResource DividerStrokeColorDefaultBrush}" Margin="0,4"/>
                                    <!-- Favorites will be added dynamically -->
                                </StackPanel>
                            </ScrollViewer>
                        </Flyout>
                    </Button.Flyout>
                </Button>

                <Button x:Name="RecentButton" Click="RecentButton_Click" ToolTipService.ToolTip="최근 이미지">
                    <FontIcon Glyph="&#xE823;" FontSize="14"/>
                    <Button.Flyout>
                        <Flyout x:Name="RecentFlyout" Placement="Bottom">
                            <ScrollViewer MaxHeight="400" Width="400" 
                                         HorizontalScrollBarVisibility="Disabled" 
                                         VerticalScrollBarVisibility="Auto">
                                <StackPanel x:Name="RecentPanel" Spacing="2">
                                    <!-- Recent items will be added dynamically -->
                                </StackPanel>
                            </ScrollViewer>
                        </Flyout>
                    </Button.Flyout>
                </Button>

                <AppBarSeparator/>

                <Button x:Name="OpenFileButton" Click="OpenFileButton_Click" ToolTipService.ToolTip="파일 열기(Ctrl+O)">
                    <StackPanel Orientation="Horizontal" Spacing="6">
                        <FontIcon Glyph="&#xE8E5;" FontSize="14"/>
                    </StackPanel>
                </Button>

                <Button x:Name="OpenFolderButton" Click="OpenFolderButton_Click" ToolTipService.ToolTip="폴더 열기">
                    <StackPanel Orientation="Horizontal" Spacing="6">
                        <FontIcon Glyph="&#xE8DA;" FontSize="14"/>
                    </StackPanel>
                </Button>


                <AppBarSeparator/>

                <!-- Image Toolbar -->
                <StackPanel x:Name="ImageToolbarPanel" Orientation="Horizontal" Spacing="4" Visibility="Visible">
                    <Button x:Name="ZoomOutButton" Click="ZoomOutButton_Click" ToolTipService.ToolTip="축소(-)">
                        <FontIcon Glyph="&#xE71F;" FontSize="14"/>
                    </Button>

                    <TextBlock x:Name="ZoomLevelText" Text="100%" Width="50" TextAlignment="Center" 
                               VerticalAlignment="Center" FontSize="12"/>

                    <Button x:Name="ZoomInButton" Click="ZoomInButton_Click" ToolTipService.ToolTip="확대(+)">
                        <FontIcon Glyph="&#xE8A3;" FontSize="14"/>
                    </Button>

                    <Button x:Name="ZoomFitButton" Click="ZoomFitButton_Click" ToolTipService.ToolTip="맞춤">
                        <FontIcon Glyph="&#xE9A6;" FontSize="14"/>
                    </Button>

                    <Button x:Name="ZoomActualButton" Click="ZoomActualButton_Click" ToolTipService.ToolTip="원본 크기">
                        <TextBlock Text="1:1" FontSize="12" FontWeight="SemiBold"/>
                    </Button>

                    <AppBarSeparator/>

                    <ToggleButton x:Name="SharpenButton" Click="SharpenButton_Click" ToolTipService.ToolTip="샤프닝(S)">
                        <ToggleButton.Resources>
                            <StaticResource x:Key="ToggleButtonForegroundPointerOver" ResourceKey="ToggleButtonForeground" />
                            <StaticResource x:Key="ToggleButtonForegroundCheckedPointerOver" ResourceKey="ToggleButtonForegroundChecked" />
                        </ToggleButton.Resources>
                        <FontIcon x:Name="SharpenIcon" Glyph="S" FontSize="14" FontFamily="Segoe UI" />
                    </ToggleButton>

                    <AppBarSeparator/>

                    <Button x:Name="SideBySideButton" Click="SideBySideButton_Click" ToolTipService.ToolTip="좌우 보기(Space)">
                        <TextBlock x:Name="SideBySideText" Text="1" FontSize="14" FontWeight="SemiBold" Width="14" TextAlignment="Center"/>
                    </Button>

                    <Button x:Name="NextImageSideButton" Click="NextImageSideButton_Click" ToolTipService.ToolTip="다음 그림 위치">
                        <TextBlock x:Name="NextImageSideText" Text="→" FontSize="12" FontWeight="SemiBold"/>
                    </Button>
                </StackPanel>

                <!-- Text Toolbar -->
                <StackPanel x:Name="TextToolbarPanel" Orientation="Horizontal" Spacing="4" Visibility="Collapsed">
                    <ToggleButton x:Name="AozoraToggleButton" Click="AozoraToggleButton_Click" ToolTipService.ToolTip="Aozora/md(A)">
                        <TextBlock Text="A" FontSize="14" FontWeight="Bold"/>
                    </ToggleButton>
                    
                    <Button x:Name="FontToggleButton" Click="FontToggleButton_Click" ToolTipService.ToolTip="폰트 변경(F)">
                        <TextBlock Text="F" FontSize="14" FontWeight="Bold"/>
                    </Button>
                    
                    <Button x:Name="TocButton" Click="TocButton_Click" ToolTipService.ToolTip="목차(T)">
                        <FontIcon Glyph="&#xE81C;" FontSize="14"/>
                        <Button.Flyout>
                            <Flyout x:Name="TocFlyout" Placement="Bottom">
                                <Grid Width="300" Height="400">
                                    <Grid.RowDefinitions>
                                        <RowDefinition Height="Auto"/>
                                        <RowDefinition Height="*"/>
                                    </Grid.RowDefinitions>
                                    <TextBlock Text="목차" FontSize="18" FontWeight="SemiBold" Margin="0,0,0,12"/>
                                    <ListView x:Name="TocListView" Grid.Row="1" SelectionMode="Single" IsItemClickEnabled="True" ItemClick="TocListView_ItemClick">
                                        <ListView.ItemTemplate>
                                            <DataTemplate>
                                                <TextBlock Text="{Binding HeadingText}" Margin="{Binding Margin}" FontSize="14" ToolTipService.ToolTip="{Binding HeadingText}" TextTrimming="CharacterEllipsis"/>
                                            </DataTemplate>
                                        </ListView.ItemTemplate>
                                    </ListView>
                                </Grid>
                            </Flyout>
                        </Button.Flyout>
                    </Button>

                    <Button x:Name="GoToPageButton" Click="GoToPageButton_Click" ToolTipService.ToolTip="페이지 이동(G)">
                        <TextBlock Text="G" FontSize="14" FontWeight="Bold"/>
                    </Button>

                    <AppBarSeparator/>

                    <Button x:Name="TextSizeDownButton" Click="TextSizeDownButton_Click" ToolTipService.ToolTip="글자 작게(-)">
                        <FontIcon Glyph="&#xE71F;" FontSize="14"/>
                    </Button>

                    <TextBlock x:Name="TextSizeLevelText" Text="18" Width="30" TextAlignment="Center" 
                               VerticalAlignment="Center" FontSize="12"/>

                    <Button x:Name="TextSizeUpButton" Click="TextSizeUpButton_Click" ToolTipService.ToolTip="글자 크게(+)">
                        <FontIcon Glyph="&#xE8A3;" FontSize="14"/>
                    </Button>

                    <AppBarSeparator/>

                    <Button x:Name="ThemeToggleButton" Click="ThemeToggleButton_Click" ToolTipService.ToolTip="배경색 변경(B)">
                        <FontIcon Glyph="&#xE790;" FontSize="14"/>
                    </Button>
                </StackPanel>

                <AppBarSeparator/>

                <Button x:Name="PrevFileButton" Click="PrevFileButton_Click" ToolTipService.ToolTip="이전 파일">
                    <TextBlock Text="&lt;&lt;" FontSize="12" FontWeight="Bold"/>
                </Button>
                <Button x:Name="PrevPageButton" Click="PrevPageButton_Click" ToolTipService.ToolTip="이전 이미지/페이지">
                    <FontIcon Glyph="&#xE76B;" FontSize="14"/>
                </Button>
                <Button x:Name="NextPageButton" Click="NextPageButton_Click" ToolTipService.ToolTip="다음 이미지/페이지">
                    <FontIcon Glyph="&#xE76C;" FontSize="14"/>
                </Button>
                <Button x:Name="NextFileButton" Click="NextFileButton_Click" ToolTipService.ToolTip="다음 파일">
                    <TextBlock Text="&gt;&gt;" FontSize="12" FontWeight="Bold"/>
                </Button>

                <Button x:Name="FullscreenButton" Click="FullscreenButton_Click" ToolTipService.ToolTip="전체화면(F11)">
                    <FontIcon x:Name="FullscreenIcon" Glyph="&#xE740;" FontSize="18"/>
                </Button>

                <Button x:Name="CloseWindowButton" Click="CloseWindowButton_Click" ToolTipService.ToolTip="닫기(Esc)">
                    <FontIcon Glyph="&#xE711;" FontSize="18"/>
                </Button>
            </StackPanel>
        </Grid>

        <!-- Main Content Area -->
        <Grid Grid.Row="2" Background="{ThemeResource SolidBackgroundFillColorBaseBrush}">
            <Grid.ColumnDefinitions>
                <ColumnDefinition x:Name="SidebarColumn" Width="320"/>
                <ColumnDefinition Width="Auto"/>
                <ColumnDefinition Width="*"/>
            </Grid.ColumnDefinitions>

            <!-- Sidebar - Folder Explorer -->
            <Grid x:Name="SidebarGrid" Grid.Column="0" Background="{ThemeResource CardBackgroundFillColorDefaultBrush}"
                  BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}" BorderThickness="0,0,1,0">
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="*"/>
                </Grid.RowDefinitions>

                <Grid Grid.Row="0" Padding="12,8" Background="{ThemeResource CardBackgroundFillColorSecondaryBrush}">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="Auto"/>
                        <ColumnDefinition Width="Auto"/>
                        <ColumnDefinition Width="Auto"/>
                        <ColumnDefinition Width="Auto"/>
                        <ColumnDefinition Width="Auto"/>
                        <ColumnDefinition Width="*"/>
                    </Grid.ColumnDefinitions>

                    <Button Grid.Column="0" x:Name="ToggleViewButton" Click="ToggleExplorerViewButton_Click"
                            ToolTipService.ToolTip="썸네일 보기" Padding="6" Margin="0,0,8,0">
                        <FontIcon Glyph="&#xE80A;" FontSize="16"/>
                    </Button>

                    <Button Grid.Column="1" x:Name="ParentFolderButton" Click="ParentFolderButton_Click"
                            ToolTipService.ToolTip="상위 폴더로 가기(Backspace)" Padding="6" Margin="0,0,8,0">
                        <FontIcon Glyph="&#xE110;" FontSize="16"/>
                    </Button>

                    <Button Grid.Column="2" x:Name="SidebarFavoritesButton" Click="SidebarFavoritesButton_Click" 
                            ToolTipService.ToolTip="즐겨찾기" Padding="6" Margin="0,0,8,0">
                        <FontIcon Glyph="&#xE734;" FontSize="16"/>
                        <Button.Flyout>
                            <Flyout x:Name="SidebarFavoritesFlyout" Placement="Bottom">
                                <ScrollViewer MaxHeight="400" Width="400" 
                                             HorizontalScrollBarVisibility="Disabled" 
                                             VerticalScrollBarVisibility="Auto">
                                    <StackPanel x:Name="SidebarFavoritesPanel" Spacing="2">
                                        <Button x:Name="SidebarAddToFavoritesButton" Content="➕ 즐겨찾기 추가" Click="AddToFavoritesMenuItem_Click" 
                                                HorizontalAlignment="Stretch" HorizontalContentAlignment="Left"
                                                Background="Transparent" BorderThickness="0"/>
                                        <Border Height="1" Background="{ThemeResource DividerStrokeColorDefaultBrush}" Margin="0,4"/>
                                        <!-- Favorites will be added dynamically -->
                                    </StackPanel>
                                </ScrollViewer>
                            </Flyout>
                        </Button.Flyout>
                    </Button>
                    
                    <Button Grid.Column="3" x:Name="SidebarRecentButton" Click="SidebarRecentButton_Click" 
                            ToolTipService.ToolTip="최근 이미지" Padding="6" Margin="0,0,8,0">
                        <FontIcon Glyph="&#xE823;" FontSize="16"/>
                        <Button.Flyout>
                            <Flyout x:Name="SidebarRecentFlyout" Placement="Bottom">
                                <ScrollViewer MaxHeight="400" Width="400" 
                                             HorizontalScrollBarVisibility="Disabled" 
                                             VerticalScrollBarVisibility="Auto">
                                    <StackPanel x:Name="SidebarRecentPanel" Spacing="2">
                                        <!-- Recent items will be added dynamically -->
                                    </StackPanel>
                                </ScrollViewer>
                            </Flyout>
                        </Button.Flyout>
                    </Button>

                    <Button Grid.Column="4" x:Name="BrowseFolderButton" Click="BrowseFolderButton_Click" 
                            ToolTipService.ToolTip="폴더 찾아보기" Padding="6">
                        <FontIcon Glyph="&#xED25;" FontSize="16"/>
                    </Button>
                </Grid>

                <!-- Current Path -->
                <Grid Grid.Row="1">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                    </Grid.RowDefinitions>

                    <TextBlock x:Name="CurrentPathText" Grid.Row="0" 
                               Text="폴더를 선택하세요" 
                               Padding="12,8" FontSize="11"
                               Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                               TextTrimming="CharacterEllipsis"/>

                    <!-- File List -->
                    <ListView x:Name="FileListView" Grid.Row="1" 
                              SelectionMode="Single"
                              SelectionChanged="FileListView_SelectionChanged"
                              IsItemClickEnabled="True"
                              ItemClick="FileItem_ItemClick"
                              PreviewKeyDown="FileListView_PreviewKeyDown">
                        <ListView.ItemTemplate>
                            <DataTemplate>
                                <Grid Padding="4,6" ColumnSpacing="8">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="Auto"/>
                                        <ColumnDefinition Width="*"/>
                                    </Grid.ColumnDefinitions>

                                    <FontIcon Grid.Column="0" Glyph="{Binding Icon}" FontSize="14"
                                              Foreground="{Binding IconColor}"/>
                                    <TextBlock Grid.Column="1" Text="{Binding Name}" 
                                               VerticalAlignment="Center"
                                               TextTrimming="CharacterEllipsis"
                                               ToolTipService.ToolTip="{Binding Name}"/>
                                </Grid>
                            </DataTemplate>
                        </ListView.ItemTemplate>
                    </ListView>

                    <GridView x:Name="FileGridView" Grid.Row="1"
                              SelectionMode="Single"
                              SelectionChanged="FileGridView_SelectionChanged"
                              PreviewKeyDown="FileGridView_PreviewKeyDown"
                              IsItemClickEnabled="True"
                              ItemClick="FileItem_ItemClick"
                              Visibility="Collapsed"
                              Padding="4">
                        <GridView.ItemTemplate>
                            <DataTemplate>
                                <Grid Width="100" Height="120" Padding="4" Background="Transparent" CornerRadius="4">
                                    <Grid.RowDefinitions>
                                        <RowDefinition Height="*"/>
                                        <RowDefinition Height="Auto"/>
                                    </Grid.RowDefinitions>
                                    
                                    <Grid Grid.Row="0">
                                        <FontIcon Glyph="{Binding Icon}" FontSize="48" Foreground="{Binding IconColor}" 
                                                  HorizontalAlignment="Center" VerticalAlignment="Center" />
                                        <Image Source="{Binding Thumbnail}" Stretch="Uniform" HorizontalAlignment="Center" VerticalAlignment="Center"/>
                                    </Grid>

                                    <TextBlock Grid.Row="1" Text="{Binding Name}" FontSize="11" 
                                               TextTrimming="CharacterEllipsis" HorizontalAlignment="Center" 
                                               MaxLines="2" TextAlignment="Center" Margin="0,4,0,0"/>
                                </Grid>
                            </DataTemplate>
                        </GridView.ItemTemplate>
                    </GridView>
                </Grid>
            </Grid>

            <controls:GridSplitter 
                x:Name="SplitterGrid"
                Grid.Column="1"
                Width="8"
                Background="Transparent"
                Foreground="{ThemeResource CardStrokeColorDefaultBrush}"
                ResizeBehavior="BasedOnAlignment"
                ResizeDirection="Columns" />

            <!-- Image Area with Win2D CanvasControl -->
            <Grid Grid.Column="2" x:Name="ImageArea" Background="{ThemeResource SolidBackgroundFillColorBaseBrush}"
                  SizeChanged="ImageArea_SizeChanged"
                  PointerWheelChanged="ImageArea_PointerWheelChanged"
                  PointerPressed="ImageArea_PointerPressed">
                <!-- Empty State -->
                <StackPanel x:Name="EmptyStatePanel" HorizontalAlignment="Center" VerticalAlignment="Center" 
                            Spacing="16" Visibility="Visible">
                    <FontIcon Glyph="&#xE8B9;" FontSize="64" Foreground="{ThemeResource TextFillColorSecondaryBrush}"/>
                    <TextBlock Text="이미지를 여기에 드래그하거나" 
                               FontSize="18" Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                               HorizontalAlignment="Center"/>
                    <TextBlock Text="'열기' 버튼을 클릭하세요" 
                               FontSize="14" Foreground="{ThemeResource TextFillColorTertiaryBrush}"
                               HorizontalAlignment="Center"/>
                    <Button Content="이미지 열기" Click="OpenFileButton_Click" 
                            Style="{StaticResource AccentButtonStyle}" HorizontalAlignment="Center" Margin="0,8,0,0"/>
                </StackPanel>

                <Grid x:Name="FastNavOverlay"
								Canvas.ZIndex="999"
								IsHitTestVisible="False"
								Visibility="Collapsed"
								Background="#80000000"
								HorizontalAlignment="Stretch"
								VerticalAlignment="Stretch">
                    <TextBlock x:Name="FastNavText"
											Foreground="White"
											FontSize="28"
											FontWeight="SemiBold"
											HorizontalAlignment="Center"
											VerticalAlignment="Center"
											Text="빠른 탐색 중... (1/1)" />
                </Grid>

                <!-- Single Image Display with Win2D -->
                <canvas:CanvasControl x:Name="MainCanvas" 
                                     Draw="MainCanvas_Draw"
                                     Visibility="Collapsed"
                                     CreateResources="MainCanvas_CreateResources"/>

                <!-- Side-by-Side Image Display with Win2D -->
                <Grid x:Name="SideBySideGrid" Visibility="Collapsed">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="*"/>
                    </Grid.ColumnDefinitions>

                    <canvas:CanvasControl x:Name="LeftCanvas" 
                                         Grid.Column="0"
                                         Draw="LeftCanvas_Draw"
                                         CreateResources="LeftCanvas_CreateResources"/>

                    <canvas:CanvasControl x:Name="RightCanvas" 
                                         Grid.Column="1"
                                         Draw="RightCanvas_Draw"
                                         CreateResources="RightCanvas_CreateResources"/>
                </Grid>
            </Grid>

            <!-- Text Display Area -->
            <Grid Grid.Column="2" x:Name="TextArea" Visibility="Collapsed" Background="{ThemeResource SolidBackgroundFillColorBaseBrush}"
                  PointerPressed="TextArea_PointerPressed" PointerWheelChanged="TextArea_PointerWheelChanged"
                  SizeChanged="TextArea_SizeChanged">
                 <ScrollViewer x:Name="TextScrollViewer" 
                               HorizontalScrollBarVisibility="Disabled"
                               VerticalScrollBarVisibility="Hidden"
                               SizeChanged="TextScrollViewer_SizeChanged"
                               ViewChanged="TextScrollViewer_ViewChanged">
                     <ItemsRepeater x:Name="TextItemsRepeater" ElementPrepared="TextItemsRepeater_ElementPrepared" 
                                    ItemTemplate="{StaticResource TextItemTemplate}">
                         <ItemsRepeater.Layout>
                             <StackLayout Spacing="0"/>
                         </ItemsRepeater.Layout>
                     </ItemsRepeater>
                 </ScrollViewer>
                 
                 <!-- Simple container for virtualized Aozora page rendering -->
                 <Grid x:Name="AozoraPageContainer" 
                       Visibility="Collapsed"
                       Padding="20"
                       PointerPressed="AozoraPageContainer_PointerPressed"
                       PointerWheelChanged="AozoraPageContainer_PointerWheelChanged"
                       SizeChanged="AozoraPageContainer_SizeChanged">
                     <ScrollViewer x:Name="AozoraPageScroll"
                                   VerticalScrollBarVisibility="Hidden"
                                   HorizontalScrollBarVisibility="Disabled">
                         <RichTextBlock x:Name="AozoraPageContent"
                                        IsTextSelectionEnabled="False"
                                        TextWrapping="Wrap"
                                        HorizontalAlignment="Left"/>
                     </ScrollViewer>
                 </Grid>
                 
                  <Grid x:Name="TextFastNavOverlay"
                        Canvas.ZIndex="999"
                        IsHitTestVisible="False"
                        Visibility="Collapsed"
                        Background="#80000000"
                        HorizontalAlignment="Stretch"
                        VerticalAlignment="Stretch">
                    <TextBlock x:Name="TextFastNavText"
                            Foreground="White"
                            FontSize="28"
                            FontWeight="SemiBold"
                            HorizontalAlignment="Center"
                            VerticalAlignment="Center"
                            Text="페이지 이동 중..." />
                </Grid>
            </Grid>
            
            <!-- Epub Display Area -->
            <Grid Grid.Column="2" x:Name="EpubArea" Visibility="Collapsed" Background="{ThemeResource SolidBackgroundFillColorBaseBrush}">
                <Grid x:Name="EpubPageDisplay" HorizontalAlignment="Stretch" VerticalAlignment="Stretch" />
                <!-- Touch Overlay for Page Navigation (left half = prev, right half = next) -->
                <Grid x:Name="EpubTouchOverlay" 
                      Background="Transparent" 
                      PointerPressed="EpubTouchOverlay_PointerPressed"
                      PointerWheelChanged="EpubTouchOverlay_PointerWheelChanged"
                      HorizontalAlignment="Stretch"
                      VerticalAlignment="Stretch"/>
                 <Grid x:Name="EpubFastNavOverlay"
                        Canvas.ZIndex="999"
                        IsHitTestVisible="False"
                        Visibility="Collapsed"
                        Background="#80000000"
                        HorizontalAlignment="Stretch"
                        VerticalAlignment="Stretch">
                    <TextBlock x:Name="EpubFastNavText"
                            Foreground="White"
                            FontSize="28"
                            FontWeight="SemiBold"
                            HorizontalAlignment="Center"
                            VerticalAlignment="Center"
                            Text="챕터 이동 중..." />
                </Grid>
            </Grid>
        </Grid>

        <!-- Status Bar -->
        <Grid x:Name="StatusBarGrid" Grid.Row="3" Padding="12,8" 
              Background="{ThemeResource CardBackgroundFillColorDefaultBrush}"
              BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}" BorderThickness="0,1,0,0">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="180"/>
                <ColumnDefinition Width="80"/>
                <ColumnDefinition Width="100"/>
            </Grid.ColumnDefinitions>

            <TextBlock x:Name="FileNameText" Grid.Column="0" 
                       Text="파일을 선택해주세요" 
                       FontSize="12" 
                       Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                       VerticalAlignment="Center"
                       TextTrimming="CharacterEllipsis"/>

            <TextBlock x:Name="ImageInfoText" Grid.Column="1" 
                       Text="" 
                       FontSize="12" 
                       Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                       VerticalAlignment="Center"
                       TextAlignment="Right"
                       Margin="0,0,16,0"/>

            <TextBlock x:Name="TextProgressText" Grid.Column="2" 
                       Text="" 
                       FontSize="12" 
                       Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                       VerticalAlignment="Center"
                       TextAlignment="Right"
                       Margin="0,0,16,0"/>

            <TextBlock x:Name="ImageIndexText" Grid.Column="3" 
                       Text="" 
                       FontSize="12" 
                       Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                       VerticalAlignment="Center"
                       TextAlignment="Right"/>
        </Grid>

        <!-- Notification Overlay -->
        <Border x:Name="NotificationOverlay" 
                Grid.RowSpan="4"
                HorizontalAlignment="Center" 
                VerticalAlignment="Bottom"
                Margin="0,0,0,100"
                Background="{ThemeResource SystemControlBackgroundChromeMediumLowBrush}"
                Padding="24,12"
                CornerRadius="20"
                BorderThickness="1"
                BorderBrush="{ThemeResource SystemControlForegroundChromeHighBrush}"
                Visibility="Collapsed"
                Canvas.ZIndex="1000">
            <Border.Shadow>
                <ThemeShadow />
            </Border.Shadow>
            <StackPanel Orientation="Horizontal" Spacing="12">
                <FontIcon Glyph="&#xE735;" Foreground="Gold" FontSize="20"/>
                <TextBlock x:Name="NotificationText" Text="즐겨찾기에 추가되었습니다" 
                           VerticalAlignment="Center" FontWeight="SemiBold"/>
            </StackPanel>
        </Border>
    </Grid>
</Window>
